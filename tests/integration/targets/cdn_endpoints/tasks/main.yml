---
- block:
    - name: Verify API token
      ansible.builtin.assert:
        that:
          - digitalocean_token is string
          - digitalocean_token | length > 0
        fail_msg: digitalocean_token should be defined in tests/integration/integration_config.yml

    - name: Verify Spaces credentials
      ansible.builtin.assert:
        that:
          - aws_access_key_id is defined
          - aws_access_key_id | length > 0
          - aws_secret_access_key is defined
          - aws_secret_access_key | length > 0
        fail_msg: aws_access_key_id and aws_secret_access_key should be defined in tests/integration/integration_config.yml

    - name: Create Space for CDN origin
      digitalocean.cloud.space:
        state: present
        aws_access_key_id: "{{ aws_access_key_id }}"
        aws_secret_access_key: "{{ aws_secret_access_key }}"
        name: "{{ space_name }}"
        region: "{{ space_region }}"
      register: space_result

    - name: Verify Space created
      ansible.builtin.assert:
        that:
          - space_result.changed or not space_result.changed
          - space_result.spaces | length == 1

    - name: Wait for Space to be ready
      ansible.builtin.pause:
        seconds: 30

    - name: Create CDN endpoint
      digitalocean.cloud.cdn_endpoints:
        token: "{{ digitalocean_token }}"
        state: present
        origin: "{{ origin }}"
        ttl: 3600
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " created"
          - result.endpoint is defined
          - result.endpoint.created_at is defined
          - result.endpoint.endpoint == endpoint
          - result.endpoint.id is defined
          - result.endpoint.origin is defined
          - result.endpoint.origin == origin
          - result.endpoint.ttl is defined

    - name: Pause for 10 seconds
      ansible.builtin.pause:
        seconds: 10

    - name: Update CDN endpoint
      digitalocean.cloud.cdn_endpoints:
        token: "{{ digitalocean_token }}"
        state: present
        origin: "{{ origin }}"
        ttl: 600
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " updated"
          - result.endpoint is defined
          - result.endpoint.created_at is defined
          - result.endpoint.endpoint == endpoint
          - result.endpoint.id is defined
          - result.endpoint.origin is defined
          - result.endpoint.origin == origin
          - result.endpoint.ttl is defined

    - name: Pause for 10 seconds
      ansible.builtin.pause:
        seconds: 10

    - name: Update CDN endpoint (no change)
      digitalocean.cloud.cdn_endpoints:
        token: "{{ digitalocean_token }}"
        state: present
        origin: "{{ origin }}"
        ttl: 600
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - not result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " exists"
          - result.endpoint is defined
          - result.endpoint.id is defined
          - result.endpoint.origin is defined
          - result.endpoint.origin == origin
          - result.endpoint.ttl is defined

    - name: Pause for 10 seconds
      ansible.builtin.pause:
        seconds: 10

    - name: Delete CDN endpoint
      digitalocean.cloud.cdn_endpoints:
        token: "{{ digitalocean_token }}"
        state: absent
        origin: "{{ origin }}"
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " deleted"
          - result.endpoint is defined

  always:
    - name: Delete CDN endpoint
      digitalocean.cloud.cdn_endpoints:
        token: "{{ digitalocean_token }}"
        state: absent
        origin: "{{ origin }}"
      ignore_errors: true

    - name: Wait before deleting Space
      ansible.builtin.pause:
        seconds: 10

    - name: Delete Space
      digitalocean.cloud.space:
        state: absent
        aws_access_key_id: "{{ aws_access_key_id }}"
        aws_secret_access_key: "{{ aws_secret_access_key }}"
        name: "{{ space_name }}"
        region: "{{ space_region }}"
      ignore_errors: true
